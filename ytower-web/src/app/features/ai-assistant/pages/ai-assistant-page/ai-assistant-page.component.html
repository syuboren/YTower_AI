<div class="ai-assistant-page">
  <!-- Breadcrumb -->
  <div class="container">
    <app-breadcrumb [items]="breadcrumbItems" />
  </div>

  <!-- AI Hero Section -->
  <section class="ai-hero">
    <!-- 背景裝飾 -->
    <div class="ai-hero__bg">
      <div class="ai-hero__bg-gradient"></div>
      <div class="ai-hero__bg-circle ai-hero__bg-circle--1"></div>
      <div class="ai-hero__bg-circle ai-hero__bg-circle--2"></div>
    </div>

    <div class="container">
      <!-- INPUT 狀態 -->
      @if (gameState() === 'INPUT') {
        <div class="game-input">
          <!-- 第一列：標題與說明 -->
          <div class="game-input__info">
            <h1 class="game-input__title">AI 食譜生成助手</h1>
            <h2 class="game-input__subtitle">從靈感到餐桌，只要一個步驟</h2>
            <p class="game-input__desc">
              冰箱有剩菜卻不知道能做什麼？讓 AI 幫你想！輸入食材，系統將為您推薦最適合的料理方案。
            </p>
          </div>

          <!-- 第二列：輸入框與按鈕 -->
          <form class="ingredient-input ingredient-input--center" (submit)="handleAddIngredient($event)">
            <input
              type="text"
              [value]="inputValue()"
              (input)="inputValue.set($any($event.target).value)"
              [disabled]="isProcessing()"
              [placeholder]="isProcessing() ? '分析中...' : '輸入食材或描述（如：冰箱裡有雞蛋、番茄、豆腐）'"
              class="ingredient-input__field"
            >
            <button
              type="submit"
              [disabled]="!inputValue() || isProcessing()"
              class="ingredient-input__btn"
            >
              @if (isProcessing()) {
                <svg class="ingredient-input__spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
                <span>生成中</span>
              } @else {
                <svg class="ingredient-input__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                <span>新增食材</span>
              }
            </button>
            <button
              type="button"
              class="ingredient-input__random"
              (click)="addRandomIngredient()"
              title="隨機新增一種食材"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <circle cx="12" cy="12" r="2"/>
                <path d="M12 6v2M12 16v2M6.93 8.5l1.73 1M15.34 14.5l1.73 1M6.93 15.5l1.73-1M15.34 9.5l1.73-1"/>
              </svg>
              <span>隨機食材</span>
            </button>
          </form>

          <!-- 分析進度提示 -->
          @if (analyzingText()) {
            <div class="analyzing-status">
              <div class="analyzing-status__indicator">
                <svg class="analyzing-status__spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
                <span class="analyzing-status__text">{{ analyzingText() }}</span>
              </div>
              @if (totalToAnalyze() > 0) {
                <div class="analyzing-status__progress">
                  <div class="analyzing-status__bar">
                    <div class="analyzing-status__fill" [style.width.%]="(analyzedCount() / totalToAnalyze()) * 100"></div>
                  </div>
                  <span class="analyzing-status__count">{{ analyzedCount() }} / {{ totalToAnalyze() }}</span>
                </div>
              }
            </div>
          }

          <!-- 第三列：食材卡匣清單與五芒星魔法陣並列（同一區塊） -->
          <div class="game-input__main">
            <!-- 左側：食材卡匣清單 -->
            <div class="hand-section">
              <!-- 手牌標題 -->
              <div class="hand-area__header">
                <span class="hand-area__title">
                  <svg class="hand-area__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/>
                    <rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/>
                    <rect x="3" y="14" width="7" height="7"/>
                  </svg>
                  食材清單 ({{ hand().length }})
                </span>
                <span class="hand-area__hint">點擊食材加入魔法陣</span>
              </div>

              <!-- 卡牌列表 - 使用原本的樣式 -->
              <div class="hand-cards">
                @if (hand().length === 0 && !isProcessing()) {
                  <div class="hand-cards__empty">
                    <svg class="hand-cards__empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    </svg>
                    <p>輸入食材開始探索...</p>
                  </div>
                }

                @if (isProcessing()) {
                  <div class="card-materializing">
                    <svg class="card-materializing__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                    </svg>
                    <span class="card-materializing__text">分析中...</span>
                  </div>
                }

                <!-- 已生成的卡牌 - 收藏卡風格（原本樣式） -->
                @for (card of hand(); track card.id) {
                  <div
                    class="collector-card"
                    [class.collector-card--selected]="isSelected(card)"
                    [style.--element-color]="getElementColor(card.element)"
                    (click)="toggleSelectCard(card)"
                  >
                    <!-- 刪除按鈕 -->
                    <button
                      type="button"
                      class="collector-card__delete"
                      (click)="removeCard(card, $event)"
                      title="移除食材"
                    >
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                      </svg>
                    </button>

                    <!-- 卡片內容 -->
                    <div class="collector-card__inner">
                      <!-- 頂部：名稱 + 數量 -->
                      <div class="collector-card__header">
                        <div class="collector-card__title-bar" [style.background]="getElementColor(card.element)">
                          <span class="collector-card__name">{{ card.name }}</span>
                        </div>
                        <div class="collector-card__count">
                          <span class="collector-card__count-label">×</span>
                          <span class="collector-card__count-value">1</span>
                        </div>
                      </div>

                      <!-- 中間：食材照片 -->
                      <div class="collector-card__image-frame">
                        <div class="collector-card__image">
                          @if (card.img && !hasImageError(card.id)) {
                            <img [src]="card.img" [alt]="card.name" (error)="handleImageError(card.id)" loading="eager">
                          } @else {
                            <div class="collector-card__fallback">
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                              </svg>
                            </div>
                          }
                        </div>

                        <!-- 選中標記 -->
                        @if (isSelected(card)) {
                          <div class="collector-card__selected-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                              <polyline points="20 6 9 17 4 12"/>
                            </svg>
                          </div>
                        }
                      </div>

                      <!-- 底部：元素標籤 -->
                      <div class="collector-card__footer">
                        <div class="collector-card__element" [style.background]="getElementColor(card.element)">
                          <!-- 元素圖示 -->
                          @if (card.element === '炎') {
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 23c-3.9 0-7-3.1-7-7 0-2.8 1.6-5.2 4-6.4V6c0-1.7 1.3-3 3-3s3 1.3 3 3v3.6c2.4 1.2 4 3.6 4 6.4 0 3.9-3.1 7-7 7z"/></svg>
                          } @else if (card.element === '水') {
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/></svg>
                          } @else if (card.element === '地') {
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                          } @else if (card.element === '風') {
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
                          } @else {
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"/></svg>
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- 右側：五芒星魔法陣 -->
            <div class="pentagram-zone">
              <div class="pentagram-container">
                <!-- 五芒星 SVG 底圖 -->
                <svg class="pentagram-svg" viewBox="0 0 300 300" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <!-- 外圈光暈 -->
                  <circle cx="150" cy="150" r="140" stroke="url(#pentagramGlow)" stroke-width="2" fill="none" opacity="0.3"/>
                  <circle cx="150" cy="150" r="130" stroke="url(#pentagramGlow)" stroke-width="1" fill="none" opacity="0.2"/>

                  <!-- 五芒星線條（基礎層 - 帶繪製動畫） -->
                  <path
                    class="pentagram-path"
                    [class.pentagram-path--drawn]="pentagramDrawn()"
                    [attr.d]="getPentagramPath()"
                    stroke="url(#pentagramGradient)"
                    stroke-width="2"
                    fill="none"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />

                  <!-- 五芒星光點流動層（白色光暈 - 疊加在基礎層上方） -->
                  <path
                    class="pentagram-glow"
                    [class.pentagram-glow--active]="pentagramDrawn()"
                    [attr.d]="getPentagramPath()"
                    fill="none"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />

                  <!-- 中心圓 -->
                  <circle cx="150" cy="150" r="25" fill="url(#centerGlow)" opacity="0.5"/>

                  <defs>
                    <linearGradient id="pentagramGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" stop-color="#F58220"/>
                      <stop offset="50%" stop-color="#C45D4A"/>
                      <stop offset="100%" stop-color="#F58220"/>
                    </linearGradient>
                    <radialGradient id="pentagramGlow" cx="50%" cy="50%" r="50%">
                      <stop offset="0%" stop-color="#F58220"/>
                      <stop offset="100%" stop-color="#C45D4A"/>
                    </radialGradient>
                    <radialGradient id="centerGlow" cx="50%" cy="50%" r="50%">
                      <stop offset="0%" stop-color="#fff"/>
                      <stop offset="100%" stop-color="#F58220"/>
                    </radialGradient>
                  </defs>
                </svg>

                <!-- 5個空白卡槽 -->
                @for (point of pentagramPoints; track $index; let idx = $index) {
                  <div
                    class="card-slot"
                    [style.left.%]="point.x"
                    [style.top.%]="point.y"
                  >
                    <!-- 空卡槽 -->
                    @if (idx >= selectedCards().length) {
                      <div class="card-slot__empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.4">
                          <rect x="3" y="3" width="18" height="18" rx="3"/>
                          <path d="M12 8v8M8 12h8"/>
                        </svg>
                      </div>
                    } @else {
                      <!-- 已填入的食材卡 -->
                      <div class="card-slot__filled" [@slotFillIn]>
                        <div
                          class="slot-card"
                          [style.background]="'linear-gradient(135deg, ' + getElementColor(selectedCards()[idx].element) + '99, ' + getElementColor(selectedCards()[idx].element) + ')'"
                        >
                          <span class="slot-card__name">{{ selectedCards()[idx].name.charAt(0) }}</span>
                          <span class="slot-card__element">{{ selectedCards()[idx].element }}</span>
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- 中心操作區 -->
                <div class="pentagram-action">
                  @if (selectedCards().length >= 2) {
                    <button type="button" class="fusion-btn" (click)="startFusion()">
                      <svg class="fusion-btn__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
                      </svg>
                      <span>開始融合</span>
                    </button>
                  } @else {
                    <div class="pentagram-hint">
                      <p>選擇 2-5 種食材</p>
                      <div class="pentagram-hint__dots">
                        @for (i of [0, 1, 2, 3, 4]; track i) {
                          <span
                            class="pentagram-hint__dot"
                            [class.pentagram-hint__dot--active]="i < selectedCards().length"
                          ></span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>

          </div>
        </div>
      }

      <!-- FUSING 狀態（五芒星融合動畫 - 5階段） -->
      @if (gameState() === 'FUSING') {
        <div class="game-fusing"
             [class.game-fusing--ready]="fusionPhase() === 'ready'"
             [class.game-fusing--summoning]="fusionPhase() === 'summoning'"
             [class.game-fusing--tracing]="fusionPhase() === 'tracing'"
             [class.game-fusing--dissolving]="fusionPhase() === 'dissolving'"
             [class.game-fusing--revealing]="fusionPhase() === 'revealing'">

          <div class="fusion-stage">
            <!-- 五芒星 SVG -->
            <svg class="fusion-pentagram" viewBox="0 0 300 300" fill="none">
              <!-- 外圈 -->
              <circle cx="150" cy="150" r="140"
                      stroke="url(#fusionGlow)"
                      stroke-width="2"
                      fill="none"
                      class="fusion-pentagram__circle"
                      [class.fusion-pentagram__circle--shimmer]="fusionPhase() === 'ready' || fusionPhase() === 'tracing'"/>

              <!-- 五芒星線條 -->
              <path
                class="fusion-pentagram__star"
                [class.fusion-pentagram__star--shimmer]="fusionPhase() === 'ready'"
                [class.fusion-pentagram__star--trace]="fusionPhase() === 'tracing'"
                [attr.d]="getPentagramPath()"
                stroke="url(#fusionGradient)"
                stroke-width="4"
                fill="none"
              />

              <!-- 微粒效果（描繪階段） -->
              @if (fusionPhase() === 'tracing') {
                <circle class="fusion-particle fusion-particle--1" cx="150" cy="30" r="4" fill="#F58220"/>
                <circle class="fusion-particle fusion-particle--2" cx="260" cy="110" r="3" fill="#fff"/>
                <circle class="fusion-particle fusion-particle--3" cx="220" cy="250" r="4" fill="#C45D4A"/>
                <circle class="fusion-particle fusion-particle--4" cx="80" cy="250" r="3" fill="#F58220"/>
                <circle class="fusion-particle fusion-particle--5" cx="40" cy="110" r="4" fill="#fff"/>
              }

              <!-- 中心 Logo -->
              <image
                href="assets/images/logo.png"
                x="110" y="110"
                width="80" height="80"
                class="fusion-pentagram__logo"
                [class.fusion-pentagram__logo--pulse]="fusionPhase() === 'dissolving'"
              />

              <defs>
                <linearGradient id="fusionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#F58220"/>
                  <stop offset="50%" stop-color="#fff"/>
                  <stop offset="100%" stop-color="#C45D4A"/>
                </linearGradient>
                <radialGradient id="fusionGlow" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" stop-color="#F58220"/>
                  <stop offset="100%" stop-color="#C45D4A"/>
                </radialGradient>
                <radialGradient id="fusionCenter" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" stop-color="#fff"/>
                  <stop offset="50%" stop-color="#F58220"/>
                  <stop offset="100%" stop-color="#C45D4A"/>
                </radialGradient>
              </defs>
            </svg>

            <!-- 卡槽與卡片 -->
            @for (point of pentagramPoints; track $index; let idx = $index) {
              <div class="fusion-slot"
                   [style.left.%]="point.x"
                   [style.top.%]="point.y">

                <!-- 空白卡槽（準備階段） -->
                @if (fusionPhase() === 'ready' || (fusionPhase() === 'summoning' && idx >= visibleCardCount())) {
                  <div class="fusion-slot__empty"
                       [class.fusion-slot__empty--shimmer]="fusionPhase() === 'ready'">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                      <rect x="3" y="3" width="18" height="18" rx="3"/>
                    </svg>
                  </div>
                }

                <!-- 食材卡片（召喚階段開始顯示） -->
                @if (idx < selectedCards().length && idx < visibleCardCount()) {
                  <div class="fusion-card"
                       [class.fusion-card--appear]="fusionPhase() === 'summoning'"
                       [class.fusion-card--dissolve]="fusionPhase() === 'dissolving'"
                       [style.--element-color]="getElementColor(selectedCards()[idx].element)"
                       [style.animation-delay.ms]="idx * 100">

                    <!-- 卡片內容 -->
                    <div class="fusion-card__inner">
                      <div class="fusion-card__header" [style.background]="getElementColor(selectedCards()[idx].element)">
                        <span>{{ selectedCards()[idx].name }}</span>
                      </div>
                      <div class="fusion-card__image">
                        <img [src]="selectedCards()[idx].img" [alt]="selectedCards()[idx].name">
                      </div>
                      <div class="fusion-card__element" [style.background]="getElementColor(selectedCards()[idx].element)">
                        {{ selectedCards()[idx].element }}
                      </div>
                    </div>

                    <!-- 分解粒子（融合階段） -->
                    @if (fusionPhase() === 'dissolving') {
                      <div class="fusion-card__particles" [style.--element-color]="getElementColor(selectedCards()[idx].element)">
                        @for (p of [1,2,3,4,5,6,7,8]; track p) {
                          <span class="fusion-card__particle" [style.--i]="p"></span>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }

            <!-- 揭曉階段：爆發過渡效果 -->
            @if (fusionPhase() === 'revealing') {
              <div class="fusion-burst">
                <div class="fusion-burst__flash"></div>
                <div class="fusion-burst__ring fusion-burst__ring--1"></div>
                <div class="fusion-burst__ring fusion-burst__ring--2"></div>
                <div class="fusion-burst__ring fusion-burst__ring--3"></div>
                <img src="assets/images/logo.png" alt="楊桃美食網" class="fusion-burst__logo">
                <h2 class="fusion-burst__text">融合完成！</h2>
              </div>
            }
          </div>

          <!-- 階段文字提示 -->
          <div class="fusion-status">
            <h2 class="fusion-status__title">
              @if (fusionPhase() === 'ready') {
                魔法陣準備中...
              } @else if (fusionPhase() === 'summoning') {
                召喚食材中...
              } @else if (fusionPhase() === 'tracing') {
                描繪魔法陣...
              } @else if (fusionPhase() === 'dissolving') {
                食材融合中...
              } @else {
                食譜誕生！
              }
            </h2>
            <div class="fusion-status__progress">
              <div class="fusion-status__bar"
                   [style.width.%]="fusionPhase() === 'ready' ? 10 :
                                    fusionPhase() === 'summoning' ? 30 :
                                    fusionPhase() === 'tracing' ? 60 :
                                    fusionPhase() === 'dissolving' ? 85 : 100">
              </div>
            </div>
          </div>
        </div>
      }

      <!-- RESULT 狀態 -->
      @if (gameState() === 'RESULT') {
        <div class="game-result" [class.game-result--changing]="isChangingBatch()">
          <div class="game-result__header game-result__header--animated">
            <h2 class="game-result__title">食譜推薦完成！</h2>
            <p class="game-result__subtitle">AI 根據您的食材，為您推薦以下食譜</p>
            <div class="game-result__batch-indicator">
              第 {{ currentBatch() + 1 }} / {{ totalBatches }} 批
            </div>
          </div>

          <!-- 食譜卡片列表 - 收藏卡風格 -->
          <div class="recipe-collector-cards">
            @for (recipe of recipeResults(); track recipe.id; let idx = $index) {
              @if (idx < visibleRecipeCount()) {
                <div
                  class="recipe-collector"
                  [class.recipe-collector--legendary]="recipe.stars >= 5"
                  [class.recipe-collector--rare]="recipe.stars >= 3 && recipe.stars < 5"
                  [class.recipe-collector--common]="recipe.stars < 3"
                  [style.animation-delay]="idx * 0.2 + 's'"
                  (click)="selectRecipe(recipe)"
                >
                  <!-- 光澤效果層 -->
                  <div class="recipe-collector__glow"></div>

                  <!-- 卡片內容 -->
                  <div class="recipe-collector__inner">
                    <!-- 頂部：名稱 + 星級 -->
                    <div class="recipe-collector__header">
                      <div class="recipe-collector__title-bar">
                        <span class="recipe-collector__name">{{ recipe.name }}</span>
                      </div>
                      <div class="recipe-collector__stars">
                        @for (star of [].constructor(recipe.stars); track $index) {
                          <span class="recipe-collector__star">★</span>
                        }
                      </div>
                    </div>

                    <!-- 圖片區域 -->
                    <div class="recipe-collector__image-frame">
                      <img [src]="recipe.img" [alt]="recipe.name" loading="lazy">
                      <div class="recipe-collector__shine"></div>
                    </div>

                    <!-- 資訊區域 -->
                    <div class="recipe-collector__info">
                      <p class="recipe-collector__desc">{{ recipe.desc }}</p>

                      <!-- 標籤 -->
                      <div class="recipe-collector__tags">
                        @for (tag of recipe.tags; track tag) {
                          <span class="recipe-collector__tag">#{{ tag }}</span>
                        }
                      </div>
                    </div>

                    <!-- 底部：烹調時間 -->
                    <div class="recipe-collector__footer">
                      <div class="recipe-collector__time">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <span>{{ recipe.cookingTime }} 分鐘</span>
                      </div>
                    </div>
                  </div>

                  <!-- 缺少食材提示 -->
                  @if (recipe.missingIngredients.length > 0) {
                    <div class="recipe-collector__missing">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                      </svg>
                      <span>缺少：</span>
                      @for (mi of recipe.missingIngredients; track mi.name) {
                        <a [href]="mi.purchaseUrl" target="_blank" class="recipe-collector__missing-link" (click)="$event.stopPropagation()">
                          {{ mi.name }}
                        </a>
                      }
                    </div>
                  }
                </div>
              }
            }
          </div>

          <!-- 操作按鈕 -->
          <div class="game-result__actions">
            @if (totalBatches > 1) {
              <button 
                type="button" 
                class="btn-game btn-game--primary" 
                (click)="nextBatch()"
                [disabled]="isChangingBatch()"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 12h14"/>
                  <path d="m12 5 7 7-7 7"/>
                </svg>
                換下一批食譜
              </button>
            }
            <button type="button" class="btn-game btn-game--secondary" (click)="resetGame()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/>
                <path d="M3 3v9h9"/>
              </svg>
              重新選擇食材
            </button>
          </div>
        </div>
      }
    </div>
  </section>

  <!-- 食譜詳情彈窗 -->
  @if (selectedRecipe()) {
    <div class="recipe-modal" (click)="closeRecipeDetail()">
      <div class="recipe-modal__content" (click)="$event.stopPropagation()">
        <button type="button" class="recipe-modal__close" (click)="closeRecipeDetail()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>

        <div class="recipe-modal__header">
          <img [src]="selectedRecipe()!.img" [alt]="selectedRecipe()!.name" class="recipe-modal__image">
          <div class="recipe-modal__overlay"></div>
          <div class="recipe-modal__title-wrap">
            <div class="recipe-modal__stars">
              @for (star of [].constructor(selectedRecipe()!.stars); track $index) {
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
              }
            </div>
            <h2 class="recipe-modal__title">{{ selectedRecipe()!.name }}</h2>
          </div>
        </div>

        <div class="recipe-modal__body">
          <p class="recipe-modal__desc">{{ selectedRecipe()!.desc }}</p>

          <div class="recipe-modal__meta">
            <span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              {{ selectedRecipe()!.cookingTime }} 分鐘
            </span>
          </div>

          <!-- 缺少食材 -->
          @if (selectedRecipe()!.missingIngredients.length > 0) {
            <div class="recipe-modal__missing">
              <h4>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="8" x2="12" y2="12"/>
                  <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                缺少食材
              </h4>
              <div class="missing-cards">
                @for (mi of selectedRecipe()!.missingIngredients; track mi.name) {
                  <div class="missing-card">
                    <svg class="missing-card__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                      <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <span class="missing-card__name">{{ mi.name }}</span>
                    <a [href]="mi.purchaseUrl" target="_blank" class="missing-card__buy">前往購買</a>
                  </div>
                }
              </div>
            </div>
          }

          <!-- 烹調步驟 -->
          <div class="recipe-modal__steps">
            <h4>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
              烹調步驟
            </h4>
            <ol class="steps-list">
              @for (step of selectedRecipe()!.steps; track $index; let i = $index) {
                <li class="steps-list__item">
                  <span class="steps-list__number">{{ i + 1 }}</span>
                  <span class="steps-list__text">{{ step }}</span>
                </li>
              }
            </ol>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Recommended Recipes -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">推薦熱門食譜</h2>
      <div class="recipe-grid">
        @for (recipe of recipes(); track recipe.id) {
          <app-recipe-card
            [id]="recipe.id"
            [title]="recipe.title"
            [imageUrl]="recipe.imageUrl"
            [cookingTime]="recipe.cookingTime"
            [rating]="recipe.rating"
          />
        }
      </div>
      <div class="section-action">
        <a routerLink="/recipes" class="btn btn--outline">
          查詢看更多的食譜？點一下！
        </a>
      </div>
    </div>
  </section>

  <!-- Recipe Categories -->
  <section class="section section--gray">
    <div class="container">
      <div class="section-header-row">
        <h2 class="section-title">推薦食譜主題</h2>
        <a routerLink="/recipes/categories" class="view-all-btn">
          <span>查看所有主題</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14"></path>
            <path d="m12 5 7 7-7 7"></path>
          </svg>
        </a>
      </div>
      <div class="category-grid">
        @for (category of categories(); track category.id) {
          <app-category-card
            [id]="category.id"
            [title]="category.title"
            [imageUrl]="category.imageUrl"
            [description]="category.description"
          />
        }
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <app-cta-section />
</div>
