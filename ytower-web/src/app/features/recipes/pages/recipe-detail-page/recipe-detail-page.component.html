<div class="recipe-detail-page">
  @if (recipe(); as recipe) {
    <div class="container">
      <app-breadcrumb [items]="breadcrumbItems()" />

      <!-- Recipe Header -->
      <header class="recipe-header scroll-animate fade-up">
        <div class="recipe-header__main">
          <h1 class="recipe-header__title">{{ recipe.title }}</h1>
          <div class="recipe-header__tags">
            <span class="recipe-tag recipe-tag--difficulty">{{ getDifficultyLabel(recipe.difficulty) }}</span>
            @for (style of recipe.cookingStyles; track style) {
              <span class="recipe-tag recipe-tag--style">{{ style }}</span>
            }
          </div>
        </div>
        
        <div class="recipe-header__actions">
          <button type="button" class="action-btn" (click)="printRecipe()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 6 2 18 2 18 9"></polyline>
              <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
              <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
            列印食譜
          </button>
          <button type="button" class="action-btn" (click)="copyLink()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
            複製連結
          </button>
          <button type="button" class="action-btn action-btn--primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
            </svg>
            收藏食譜
          </button>
          <button type="button" class="action-btn action-btn--social" (click)="shareToFacebook()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"/>
            </svg>
          </button>
          <button type="button" class="action-btn action-btn--social" (click)="shareToLine()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M24 10.304c0-5.369-5.383-9.738-12-9.738-6.616 0-12 4.369-12 9.738 0 4.814 4.269 8.846 10.036 9.608.391.084.922.258 1.057.592.121.303.079.778.039 1.085l-.171 1.027c-.053.303-.242 1.186 1.039.647 1.281-.54 6.911-4.069 9.428-6.967 1.739-1.907 2.572-3.843 2.572-5.992zm-18.988-2.595c.129 0 .234.105.234.234v4.153c0 .129-.105.234-.234.234h-.947a.235.235 0 0 1-.234-.234v-4.153c0-.129.105-.234.234-.234h.947zm15.476 0c.129 0 .234.105.234.234v.947a.235.235 0 0 1-.234.234h-2.072v.792h2.072c.129 0 .234.105.234.234v.947a.235.235 0 0 1-.234.234h-2.072v.792h2.072c.129 0 .234.105.234.234v.947a.235.235 0 0 1-.234.234h-3.253a.235.235 0 0 1-.234-.234v-4.153c0-.129.105-.234.234-.234h3.253z"/>
            </svg>
          </button>
        </div>

        <div class="recipe-header__meta">
          <span class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            烹飪時間：{{ recipe.cookingTime }} 分鐘
          </span>
          <span class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 4v6a6 6 0 0 0 12 0V4"></path>
              <line x1="4" y1="21" x2="20" y2="21"></line>
            </svg>
            準備時間：{{ recipe.prepTime || 10 }} 分鐘
          </span>
          <span class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            標準食用人數：{{ recipe.servings }} 人份
          </span>
          <span class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            上傳日期：{{ recipe.uploadDate }}
          </span>
          <span class="meta-item meta-item--collect">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            已有 1,234 人收藏這道食譜！你也來試試吧！
          </span>
        </div>
      </header>

      <!-- Recipe Description -->
      <section class="recipe-intro scroll-animate fade-up">
        <div class="recipe-intro__image">
          <img [src]="recipe.imageUrl" [alt]="recipe.title" loading="lazy">
        </div>
        <p class="recipe-intro__description">{{ recipe.description }}</p>
      </section>

      <!-- Ingredients & Video -->
      <div class="recipe-content">
        <div class="recipe-content__main">
          <!-- Ingredients -->
          <section class="ingredients-section scroll-animate fade-right">
            <div class="section-header">
              <h2 class="section-title">材料</h2>
            </div>

            <div class="ingredients-table">
              <div class="ingredients-column">
                <h3 class="ingredients-column__title">食材</h3>
                @for (ing of recipe.ingredients; track ing.name) {
                  <div class="ingredient-row">
                    <span class="ingredient-name">{{ ing.name }}</span>
                    <span class="ingredient-amount">{{ ing.amount }} {{ ing.unit }}</span>
                  </div>
                }
              </div>
              <div class="ingredients-column">
                <h3 class="ingredients-column__title">調味料</h3>
                @for (group of recipe.seasonings; track group.group) {
                  <div class="seasoning-group">
                    <span class="seasoning-label">調味料 {{ group.group }}</span>
                    @for (item of group.items; track item.name) {
                      <div class="ingredient-row">
                        <span class="ingredient-name">{{ item.name }}</span>
                        <span class="ingredient-amount">{{ item.amount }}</span>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          </section>

          <!-- Kitchenware -->
          @if (recipe.kitchenware && recipe.kitchenware.length > 0) {
            <section class="kitchenware-section scroll-animate fade-right">
              <h2 class="section-title">使用器具</h2>
              <div class="kitchenware-list">
                @for (item of recipe.kitchenware; track item.id) {
                  <div class="kitchenware-item">
                    <span class="kitchenware-name">{{ item.name }}</span>
                    <a [href]="item.purchaseUrl" target="_blank" class="kitchenware-link">立即選購</a>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Steps -->
          <section class="steps-section scroll-animate fade-up">
            <h2 class="section-title">製作步驟</h2>
            <ol class="steps-list">
              @for (step of recipe.steps; track step.stepNumber) {
                <li class="step-item" [class.step-item--completed]="isStepCompleted(step.stepNumber)">
                  <label class="step-checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="isStepCompleted(step.stepNumber)"
                      (change)="toggleStep(step.stepNumber)"
                    >
                    <span class="step-checkmark"></span>
                  </label>
                  <div class="step-content">
                    <span class="step-number">步驟 {{ step.stepNumber }}</span>
                    <p class="step-description">{{ step.description }}</p>
                  </div>
                </li>
              }
            </ol>
          </section>

          <!-- Tags -->
          <section class="tags-section scroll-animate fade-up">
            <h3 class="tags-title">此食譜標籤</h3>
            <div class="tags-group">
              <span class="tags-label">難易度：</span>
              <div class="tags-list">
                <span class="tag tag--active">簡單</span>
                <span class="tag">中等</span>
                <span class="tag">困難</span>
              </div>
            </div>
            <div class="tags-group">
              <span class="tags-label">類型：</span>
              <div class="tags-list">
                @for (tag of recipe.tags; track tag) {
                  <span class="tag tag--active">{{ tag }}</span>
                }
              </div>
            </div>
            <div class="tags-group">
              <span class="tags-label">烹飪時間：</span>
              <div class="tags-list">
                <span class="tag">1分鐘</span>
                <span class="tag tag--active">20分鐘</span>
                <span class="tag">1小時+</span>
              </div>
            </div>
            <div class="tags-group">
              <span class="tags-label">食材：</span>
              <div class="tags-list">
                <span class="tag tag--active">豆腐</span>
                <span class="tag tag--active">辣椒</span>
                <span class="tag tag--active">花椒</span>
              </div>
            </div>
          </section>
        </div>

        <!-- Video Section -->
        <aside class="recipe-content__video scroll-animate fade-left">
          <div class="video-wrapper">
            <img [src]="recipe.imageUrl" [alt]="recipe.title" loading="lazy">
            <button type="button" class="video-play-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
          </div>

          <!-- Nutrition Info -->
          <div class="nutrition-card">
            <h3 class="nutrition-card__title">營養資訊</h3>
            <p class="nutrition-card__subtitle">每份含量（{{ recipe.servings }}人份）</p>
            <div class="nutrition-grid">
              <div class="nutrition-item">
                <span class="nutrition-value">{{ nutritionInfo().calories }}</span>
                <span class="nutrition-label">卡路里</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-value">{{ nutritionInfo().protein }}g</span>
                <span class="nutrition-label">蛋白質</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-value">{{ nutritionInfo().fat }}g</span>
                <span class="nutrition-label">脂肪</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-value">{{ nutritionInfo().carbs }}g</span>
                <span class="nutrition-label">碳水</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-value">{{ nutritionInfo().fiber }}g</span>
                <span class="nutrition-label">纖維</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-value">{{ nutritionInfo().sodium }}mg</span>
                <span class="nutrition-label">鈉</span>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <!-- Rating Section -->
      <section class="rating-section scroll-animate fade-up">
        <div class="rating-card">
          <div class="rating-card__existing">
            <h3>食譜評價</h3>
            <div class="rating-display">
              <span class="rating-score">{{ recipe.rating }}</span>
              <div class="rating-stars">
                @for (star of [1,2,3,4,5]; track star) {
                  <span class="star" [class.star--filled]="star <= recipe.rating">★</span>
                }
              </div>
              <span class="rating-count">({{ recipe.ratingCount }})</span>
            </div>
          </div>
          <div class="rating-card__user">
            <h3>你的評價</h3>
            <div class="rating-input">
              @for (star of [1,2,3,4,5]; track star) {
                <button 
                  type="button"
                  class="star-btn" 
                  [class.star-btn--active]="star <= userRating()"
                  (click)="setRating(star)"
                >
                  @if (star <= userRating()) {
                    ★
                  } @else {
                    ☆
                  }
                </button>
              }
            </div>
          </div>
        </div>
      </section>

      <!-- Related Recipes -->
      <section class="related-section scroll-animate fade-up">
        <div class="section-header-row">
          <h2 class="section-title">其他相似食譜推薦</h2>
        </div>
        <div class="related-grid">
          @for (related of relatedRecipes(); track related.id) {
            <app-recipe-card
              [id]="related.id"
              [title]="related.title"
              [imageUrl]="related.imageUrl"
              [cookingTime]="related.cookingTime"
              [rating]="related.rating"
            />
          }
        </div>
      </section>

      <!-- Recommended Products -->
      <section class="products-section scroll-animate fade-up">
        <div class="section-header-row">
          <h2 class="section-title">推薦！此食譜適用之廚具！</h2>
        </div>
        <div class="products-scroll">
          @for (product of recommendedProducts(); track product.id) {
            <a [href]="product.purchaseUrl" target="_blank" class="product-card">
              <div class="product-card__image">
                <img [src]="product.imageUrl" [alt]="product.name" loading="lazy">
                @if (product.isHot) {
                  <span class="product-card__badge">熱銷</span>
                }
              </div>
              <div class="product-card__content">
                <h4 class="product-card__name">{{ product.name }}</h4>
                <div class="product-card__price">
                  @if (product.originalPrice) {
                    <span class="product-card__original">NT$ {{ product.originalPrice }}</span>
                  }
                  <span class="product-card__current">NT$ {{ product.price }}</span>
                </div>
              </div>
            </a>
          }
        </div>
      </section>

      <!-- Featured Themes -->
      <section class="themes-section scroll-animate fade-up">
        <div class="section-header-row">
          <h2 class="section-title">推薦食譜主題</h2>
        </div>
        <div class="themes-grid">
          @for (theme of featuredThemes(); track theme.slug) {
            <a [routerLink]="['/recipes', 'theme', theme.slug]" class="theme-card">
              <div class="theme-card__image">
                <img [src]="theme.imageUrl" [alt]="theme.title" loading="lazy">
                <div class="theme-card__overlay"></div>
              </div>
              <div class="theme-card__content">
                <h3 class="theme-card__title">{{ theme.title }}</h3>
                <p class="theme-card__desc">{{ theme.description }}</p>
                <span class="theme-card__link">查看食譜主題 →</span>
              </div>
            </a>
          }
        </div>
      </section>
    </div>

    <app-cta-section />
  } @else {
    <div class="container">
      <div class="not-found">
        <h1>找不到此食譜</h1>
        <p>抱歉，您要找的食譜不存在或已被移除。</p>
        <a routerLink="/recipes" class="btn">返回食譜列表</a>
      </div>
    </div>
  }
</div>
